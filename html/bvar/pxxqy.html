<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<link rel="stylesheet" type="text/css" href="../../css/aui.2.0.css" />
		<link rel="stylesheet" type="text/css" href="../../css/color.css" />
		<title class="aui-text-center">在线考试</title>
		<script type="text/javascript">
       // 诸葛布点
        window.zhuge = window.zhuge || [];
        window.zhuge.methods = "_init debug identify track trackLink trackForm page".split(" ");
        window.zhuge.factory = function(b) {
            return function() {
                var a = Array.prototype.slice.call(arguments);
                a.unshift(b);
                window.zhuge.push(a);
                return window.zhuge;
            }
        };
        for (var i = 0; i < window.zhuge.methods.length; i++) {
            var key = window.zhuge.methods[i];
            window.zhuge[key] = window.zhuge.factory(key);
        }
        window.zhuge.load = function(b, x) {
                if (!document.getElementById("zhuge-js")) {
                    var a = document.createElement("script");
                    var verDate = new Date();
                    var verStr = verDate.getFullYear().toString()
                        + verDate.getMonth().toString() + verDate.getDate().toString();
                    a.type = "text/javascript";
                    a.id = "zhuge-js";
                    a.async = !0;
                    a.src = (location.protocol == 'http:' ? "http://sdk.zhugeio.com/zhuge-lastest.min.js?v=" : 'https://zgsdk.zhugeio.com/zhuge-lastest.min.js?v=') + verStr;
                    var c = document.getElementsByTagName("script")[0];
                    c.parentNode.insertBefore(a, c);
                    window.zhuge._init(b, x)
                }
            };
            window.zhuge.load('1cc4eb544aa548698b0abf171c2ad6f5');var token =localStorage.getItem('token');
            if(token){
                zhuge.identify(token,{
                    "来源":"微信"
                });
            }
    </script>
		<style>
			body {
				background-color: #ffffff;
			}
			.aui-card-list-header strong:before {
				content: '';
				height: 1.2 rem;
				width: 3px;
				background-color: #009ce9;
				position: absolute;
				left: 2px;
			}
			.round-tag {
				margin-top: 1.5 rem;
				margin: 0 auto;
				width: 6.5 rem;
				border-radius: 3rem;
			}
			pre {
				white-space: pre-wrap;
				overflow-x: auto;
			}
			.border-tag:before {
				content: '';
				height: 1px;
				width: 100%;
				background-color: #e9e9e9;
				position: absolute;
				top: -0.5 rem;
			}
			.border-tag:after {
				content: '';
				height: 1px;
				width: 100%;
				background-color: #e9e9e9;
				position: absolute;
			}
			.position-a-tag {
				position: absolute;
				right: 0;
				top: 2px;
				color: #42abec;
			}
			.border-color {
				width: 100%;
				height: 5px;
				background-color: #f5f5f5;
			}
			.aui-card-list-header strong:before{
		        content: '';
		        height: 1.2rem;
		        width: 3px;
		        background-color: #009ce9;
		        position: absolute;
		        left: 2px;
		     }
		     img{
		     	width:100%;
		     	height:auto;
		     }
		     iframe{
		     	width:100%;
		     	height:auto;
		     }
		</style>
	</head>
	<body>
		<!--培训详情页面-->
		<!-- 滑动页 -->
		<div class="aui-tab" id="tab">
			<div class="aui-tab-item aui-active">
				培训
			</div>
			<div class="aui-tab-item">
				考试
			</div>
		</div>
		<section id="list">

		</section>
		<!-- 培训 -->
		<script type="text/x-dot-template" id="list-tpl-1">
			<section >
				<section class="aui-content-padded aui-card-list" >
					<div class="aui-card-list-header">
						<strong class="aui-font-size-18">{{=it.title||''}}</strong>
					</div>
					<div class="aui-row">
						<div class="aui-col-xs-7 font-size-13 text-bfbfbf">
							<span>{{=formatTime(it.releasedate)||''}}</span> &nbsp;
							<i class="aui-iconfont aui-icon-note aui-margin-r-5"></i>{{=it.lookcount||''}} &nbsp;
							<i id="zanIcon" class="aui-iconfont aui-icon-laud" onclick="doZan()"></i> <span status="0" id="zan" >{{=it.zan||'0'}}</span>
						</div>
						<div class="aui-col-xs-5 aui-text-right aui-font-size-12 text-bfbfbf">
							<span >来源：{{=it.source||''}}</span>
						</div>
					</div>
				</section>
				<!-- 文章内容 -->
				<section class="aui-content-padded">
					<div class="aui-card-list border-tag" >
						{{=it.content||''}}
					</div>
				</section>
			</section>
		</script>
		<!-- 考试 -->
		<script type="text/x-dot-template" id="list-tpl-2">
			<section  class="">
				<div class="border-color"></div>
				<div class="aui-content aui-margin-b-15 aui-border-b">
					<div class="aui-row"></div>
					<h6 class="aui-text-center text-333333 aui-padded-t-10  aui-font-size-14">{{=it.examname||''}}
						<a id="ksjl" onclick="openurl('{{=it.id}}')" class="aui-pull-right aui-padded-r-15 aui-font-size-12">查看所有考试</a>
					</h6>
				<!-- 单项选择 -->
				{{for(var i in it.examcontent){}}
					<!--如果type==1，单选-->
					{{? it.examcontent[i].type==1}}
					<div class="aui-padded-l-15 aui-padded-r-15 aui-padded-b-15">
						<div class="text-333333 aui-border-b aui-padded-b-10 aui-padded-t-10 aui-font-size-14">
							单项选择（{{=it.examcontent[i].score||''}}分）
						</div>
						<!--单选答案-->
						<p class="text-333333 aui-padded-t-10 font-size-13">
							<!--题目-->
							{{=it.examcontent[i].title||''}}
							<input type="hidden" data-id="{{=it.examcontent[i].id}}" value="{{=it.examcontent[i].id}}"/>
						<p>
							<!--选择项-->
						{{for(var j in it.examcontent[i].selects){}}
						<p class="text-333333 aui-padded-t-15 aui-padded-l-10 font-size-13">
							<input type="radio" name="{{=it.examcontent[i].id}}" id="main-{{=i}}{{=j}}"  data-answer="{{=way(it.examcontent[i].selects[j].content)}}" class="main-{{=it.examcontent[i].id}} aui-radio input-style">
							<label for="main-{{=i}}{{=j}}">{{=it.examcontent[i].selects[j].content||''}}</label>
						<p>
						{{}}}
					</div>
					<!--如果type==2，多选-->
					{{?? it.examcontent[i].type==2}}
					<!-- 多项选择 -->
					<div class="aui-padded-l-15 aui-padded-r-15 aui-padded-b-15">
						<div class="text-333333 aui-border-b aui-padded-b-10 aui-padded-t-10 aui-font-size-14">
							多项选择（{{=it.examcontent[i].score||''}}分）
						</div>
						<!--多选答案-->
						<p class="text-333333 aui-padded-t-10 font-size-13">
							{{=it.examcontent[i].title||''}}
							<input type="hidden" data-id="{{=it.examcontent[i].id}}" value="{{=it.examcontent[i].id}}"/>
						<p>
							{{for(var j in it.examcontent[i].selects){}}
						<p class="text-333333 aui-padded-t-15 aui-padded-l-10 font-size-13">
							<input type="checkbox" id="main-{{=i}}{{=j}}"  class="main-{{=it.examcontent[i].id}} aui-checkbox input-style" data-answer="{{=way(it.examcontent[i].selects[j].content)}}"/>
								<label for="main-{{=i}}{{=j}}">{{=it.examcontent[i].selects[j].content||''}}</label>
						<p>
							{{}}}
					</div>
					{{?}}
				{{}}}
				</div>
				
				<!-- 提交 -->
				<div class="aui-crad-list text-808080 aui-padded-t-10 aui-padded-b-10" onclick="submit('{{=it.id}}')" id="submit">
					<div class="aui-crad-list-footer aui-text-center font-size-13">
						<span class="submit-tag bg-009ce9-blue aui-font-size-14">提交<span>
					</div>
				</div>
			</section>
		</script>
		<script type="text/x-dot-template" id="list-tpl-3">
			<section  class="">
				<div class="border-color"></div>
				<div class="aui-content aui-margin-b-15 ">
					<div class="aui-row"></div>
					<h6 class="aui-text-center text-333333 aui-padded-t-10  aui-font-size-14">
						<a id="ksjl" onclick="openurl()" class=" aui-padded-r-15 aui-font-size-12">查看所有考试</a>
					</h6>
				</div>
				<img src="../../image/pxxqy01.png" alt="" style="width:15%;height:auto;margin:0 auto;display: block;margin-top:45%;"/>
				<div style="text-align: center;">考试未开始</div>
			</section>
		</script>
	</body>
	<script type="text/javascript" src="../../script/aui-tab.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../../script/doT.min.js"></script>
	<script type="text/javascript" src="../../script/aui-toast.js"></script>
	<script type="text/javascript" src="../../script/aui-dialog.js"></script>
	<script type="text/javascript">
		var toast = new auiToast();
		var pageNo = 0; //根据文档要求pageNo为0，对应文档中的skip参数
    	var loadStatus = true; //判断加载的状态
    	var searchStr = window.location.search.substr(1); //获得当前页面搜索数据
    	var searchArr = searchStr.split('='); //根据等号切割成数组
    	var searchId = searchArr[1]; //获取等号后面元素
    	var startDate;//开始考试时间
    	var startLength;//开始时间的毫秒数
    	var endDate;//考试点提交结束时间
    	var grade;//提交成功后返回的成绩
    	var examid="";
    	var answerNums=["A","B","C","D","E","F","G","H","I","J","K"];
//		var token="?access_token=2JFkLwPi5HusOjsk0gjPdSiHe5vGbR2WW1wEgvADocLRVqtMBwgb14vPnlCqCT0N";
		var token = "?access_token="+localStorage.getItem('token');
		//如果未登录直接跳登录页
		if(!localStorage.getItem('token')){
			window.location.href = BASE_URL+'/html/register/bvar_register.html';
		}
    	//页面dot中的判断,获取题目中的首个字母，当做所选的答案
		function way(param){
			var num=param.substr(0,1);
			return num;
		}
	    $(function(){
	    	var index=1;
	    	toast.loading({
	            title:"加载中",
	            duration:2000
	        },function(ret){
				setTimeout(function(){
	                getData(index);
	            }, 500)
    		});
        	var tab = new auiTab({
				element : document.getElementById("tab"),
				index : 1,
				repeatClick : false
			}, function(ret) {
				if (ret.index == 1) {
					 index=1;
					 $("#list").html("");//先清空页面，以免未返回数据的时候不清页面
					 getData(index);//培训文章详情
				} else {
					if(!localStorage.getItem('token')){
//						toast.fail({
//				            title:'您未登录,请先登录！',
//				            duration:2000
//				        },function(ret){
//			    		});
			    		window.location.href = BASE_URL+'/html/register/bvar_register.html';
			    		return;
			    	}
					index=2;
					$("#list").html("");//先清空页面，以免未返回数据的时候不清页面
					examJudge(index);
				}
        	});

	    })
	    //先判断是否允许考试
	    function examJudge(index){
	    		var url=INTEL_API_URL_B+'/jyh_dimexams/allowExam'+token;
	    		var datas={
					examid:searchId
	    		};
	    	$.ajax({
	    		url:url,
	    		type:'post',
	    		dataType:'json',
	    		data:datas,
	    		success:function(ret){
	    			toast.hide();
//	    			alert(JSON.stringify(ret));
	    			//如果code：1允许考试
	    			if(ret.code==1){
			            getData(index,1);//加载考试页面
	    			}else if(ret.code==0){
	    				toast.fail({
				            title:"您目前不能考试",
				            duration:2000
				        },function(ret){
			    		});
			    		setTimeout(function(){
			                getData(index,0);
			            }, 500);
	    			}
	    		},
	    		error:function(err){
	    			toast.hide();
//	    			alert(JSON.stringify(err));
	    			var message=err.responseJSON.error.message;
	    			toast.fail({
			            title:message,
			            duration:2000
			        },function(ret){
		    		});
    			}
	    	});
	    }
	    function getData(tag,code){
	    	loadStatus = false;
	    	if(tag==1){//在线培训文章详情
	    		var url=INTEL_API_URL_B+'/jyh_factresources/viewArticle';
	    		var datas={
	    			id:searchId
	    		};
	    		var type='post';
	    	}else{//在线培训考试列
	    		var url=INTEL_API_URL_B+'/jyh_dimexams/getExamPaperInfoById'+token;
	    		var datas={
					id:examid
	    		};
	    		var type='post';
	    	}
//	    	alert('提交的数据'+JSON.stringify(datas));
	    	$.ajax({
	    		url:url,
	    		type:type,
	    		dataType:'json',
	    		data:datas,
	    		success:function(ret){
	    			if(ret){
	    			console.log(JSON.stringify(ret));
	    				switch (tag) {
	                        case 1: //培训详情
	                        if(ret.examid){
	                        	examid=ret.examid;
	                        }
	                        	toast.hide();
	                            //将考试内容填充页面
	                            var tempFn = doT.template($("#list-tpl-1").html());
	    						$("#list").append(tempFn(ret));
	                            break;
	                        case 2: //考试
	                        	//开始考试时间
			    				var newDate = new Date();
			    				startDate = newDate.getFullYear() + '-' + (parseInt(newDate.getMonth())+1) + '-' + newDate.getDate()+ ' ' + newDate.getHours() + ':' + newDate.getMinutes()+ ':' +newDate.getSeconds()+'.' + newDate.getMilliseconds();
			    				startLength = newDate.getTime();//开始考试的毫秒数
			    				//将考试内容填充页面
	                            var tempFn = doT.template($("#list-tpl-2").html());
	    						$("#list").append(tempFn(ret));
	    						 toast.hide();
	    						 //比较是未开始的考试还是进行中的考试还是已结束的考试
	    						 var thisStartdate=ret.startdate.substr(0,10);//试卷的开始日期
	                             var thisEnddate=ret.enddate.substr(0,10);//试卷的截止日期
	                             var month=newDate.getMonth()+1;
							    var date = newDate.getDate();
							    if(month<10){month = '0'+month}
							    if(date<10){date = '0'+date}
							    var applydate = newDate.getFullYear() + '-' + month + '-' + date;//当前年月日
	                             var startdateVS=dateCompare(thisStartdate,applydate);//试卷的开始时间与当前时间比较
	                             var enddateVS=dateCompare(applydate,thisEnddate);//当前时间与试卷的结束时间比较
	                             //如果开始时间大于当前时间，未开始
	                             if(startdateVS==1){
	                             	//将考试内容填充页面
	                            	var tempFn = doT.template($("#list-tpl-3").html());
	                            	$("#list").html("");
	    							$("#list").append(tempFn());
	                             }
	                             
	                             //如果当前时间大于结束时间，已结束
	                             if(enddateVS==1){
	                             	$('#submit').attr('onclick',"");
					        		$('#submit>div>span').removeClass("bg-009ce9-blue");
					        		$('#submit>div>span').css({
					        			'background':'#eee',
					        			'color':'#666'
					        		});
	                             }
	                             
	                            break;
	                            
	                    }
	    				// 因为默认就显示了loading效果，也就是当pageNo分页等于0的时候显示，那么当pageNo等于0的时候将loading隐藏
	                    if(pageNo == 0){
	                        toast.hide();
	                    }
	                    if(code==0){//不允许考试但是能看页面，不允许提交
	                    	$('#submit').attr('onclick',"");
			        		$('#submit>div>span').removeClass("bg-009ce9-blue");
			        		$('#submit>div>span').css({
			        			'background':'#eee',
			        			'color':'#666'
			        		});
	                    }
	                     // 成功写入数据后pageNo递增
	                    pageNo++;
	                    // 将loadStatus设置为true，可以继续加载数据喽
	                    loadStatus = true;
	    			}else{
	    				toast.hide();
	    				// 当没有数据返回并且pageNo等于0时，说明没有数据（当没有数据返回并且pageNo大于0时，说明没有更多了）
	    				if(pageNo == 0){
	    					$("#list").html('<p class="aui-text-center aui-padded-t-15 aui-padded-b-15">暂无数据</p>');
	    				}else{
                         	$("#list").append('<p class="aui-text-center aui-padded-t-15 aui-padded-b-15">没有更多了</p>');
                    	}
                    	// 既然没有数据也没有更多了，就将loadStatus设置为false，不允许加载了
                    	loadStatus = false;

	    			}
	    		},
	    		error:function(err){
//	    			alert(JSON.stringify(ret));
	    			// 错误处理
               		toast.hide();
                	loadStatus = false;
                	$("#list").html('<p class="aui-text-center aui-padded-t-15 aui-padded-b-15">出错啦</p>');
    			}
	    	});
	    }
	    //比较时间大小
	    function dateCompare(date1,date2){
			date1 = date1.replace(/\-/gi,"/");
			date2 = date2.replace(/\-/gi,"/");
			var time1 = new Date(date1).getTime();
			var time2 = new Date(date2).getTime();
			if(time1 > time2){
				return 1;
			}else if(time1 == time2){
				return 2;
			}else{
				return 3;
			}
		}
		//打开考试记录列表
		function openurl(id){
			zhuge.track("微信_bvar_考试纪录列表");
			window.location.href = BASE_URL+'/html/bvar/zxks.html?id='+id;
		}
		//提交考试
		function submit(id){
			var endDate = new Date();
			var endLength=endDate.getTime();//结束时间的毫秒数
			//考试总时间，单位：秒
			var examlength=Math.round((parseInt(endLength)-parseInt(startLength))/1000);
			//上传给服务器的答案
			var answers=[];
			//获取所有带data-id的input
			var dataId=document.querySelectorAll('input[data-id]');

			//用data-id的值，去匹配当题中的class为main-该值的input
			for(var i=0; i<dataId.length; i++){
				var contentId=dataId[i].value;
				var inputs = $('.main-'+contentId);
				//将data-id值放入一个json中，字段：id，
				var answerA={};
				answerA.id=contentId;
				//将匹配到的class的input为checked中的data-answer属性的值，以数组的形式放入同一个json中，字段：answer；
				var inputCheckeds=[];
				var answerAll=[];//放答案A，B，C，D的数组
				for(var j=0; j<inputs.length; j++){
					if(inputs[j].checked){
//						var answerB=inputs[j].getAttribute('data-answer');
						var answerB=answerNums[j];
						answerAll.push(answerB);
						inputCheckeds.push(j);
					}
				}
				if(inputCheckeds.length<1){
					toast.fail({
				            title:"还有题目未选择",
				            duration:1000
				        },function(ret){
			    		});
			    		return;
				}
				//将答案封装数组answerB后以字段：answer放入answerA；
				answerA.answer=answerAll;
				//将每个题目的json都放到answers里
				answers.push(answerA);
			}
//			console.log('提交的答案：'+JSON.stringify(answers));
			toast.loading({
	            title:"提交中",
	            duration:500
	        },function(ret){
    		});

			$.ajax({
				url:INTEL_API_URL_B+'/jyh_dimexams/judgeScore'+token,
				type:'post',
				data:{
					examid:id,//试卷id
					examdate:startDate,//考试开始时间
					examlength:examlength,//考试时长（秒）
//					userid:'',//用户账号
					answers:answers
				},
				success:function(ret){
//					console.log("提交后返回的数据："+JSON.stringify(ret));
					if(ret.code==1){
						grade=ret.score;//考试分数
						if(grade==100){
							toast.hide();
							alertMark(100,id);
						}else{
							toast.hide();
							alertMark(80,id);
						}
					}else{
						toast.hide();
						toast.fail({
				            title:ret.message,
				            duration:1000
				        },function(ret){
			    		});
					}
				},
				error:function(err){
					toast.hide();
					toast.fail({
				            title:"出错了",
				            duration:1000
				        },function(ret){
			    		});

				}
			});
		}
		//弹窗页面
		function alertMark(param,id){
	        var dialog = new auiDialog();
	        if(param==100){
	        	dialog.alert({
		            title:"本次考试得分：<span style='color:red;'>"+grade+"分</span>",
		            //msg:'',
		            buttons:['好']
		        },function(ret){
		            window.location.href = BASE_URL+'/html/bvar/ksjl.html?id='+id;
		        })
	        }else{
		        dialog.alert({
		            title:"本次考试得分：<span style='color:red;'>"+grade+"分</span>",
		            //msg:'',
		            buttons:['再考一次','好']
		        },function(ret){
		            //按钮序号1为取消,2为确定
	    			var index = ret.buttonIndex;
	    			if(index==2){
	    				window.location.href = BASE_URL+'/html/bvar/ksjl.html?id='+id;
	    			}else{
//	    				window.location.href = BASE_URL+'/html/bvar/zxpxlb.html?id='+id;
						window.history.go(0);//刷新当前页
	    			}
		        })
	        }
	    }
    // 点赞
    function doZan(){
    	zhuge.track("微信_bvar_点赞");
        if($('#zan').attr('status') == 0){
            var zanText = parseInt($('#zan').text());
            zanText++;
            $('#zan').text(zanText);
            $('#zanIcon').css('color', 'red');
            $('#zan').attr('status', 1);
            $.ajax({
                url: INTEL_API_URL_B+"/jyh_factresources/PointPraiseArticles"+token,
                type: 'POST',
                data: {
                    id: searchId
                },
                success: function(ret){
                    toast.success({
                        title: '点赞成功!'
                    })
                }
            })
        } else {
            return;
        }
    }
    // 获取时间格式 (精确到天)
    function formatTime(timeStr){
        var str = timeStr.substr(0, 10);
        str = str.replace(/-/g,"/");
        return str;
    }
</script>
</html>
